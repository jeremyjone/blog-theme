---

---

<div id="search-modal" class="search-modal" style="display: none;">
    <div class="search-overlay"></div>
    <div class="search-container">
        <div class="search-header">
            <input
                type="text"
                id="search-input-global"
                placeholder="搜索全站内容 (Cmd+K)..."
                autocomplete="off"
            />
            <button id="close-search" aria-label="Close search">&times;</button>
        </div>
        <div id="search-results-global" class="search-results">
            <div class="search-placeholder">输入关键词开始搜索...</div>
        </div>
    </div>
</div>

<style>
    .search-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 10vh;
    }

    .search-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
    }

    .search-container {
        position: relative;
        width: 90%;
        max-width: 800px;
        background: var(--color-bg-primary);
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        max-height: 80vh;
        border: 1px solid var(--color-border);
    }

    :global([data-theme="dark"] .search-container) {
        background: #1a1a1a;
        border: 1px solid #333;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    :global([data-theme="light"] .search-container) {
        background: #ffffff;
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    .search-header {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid var(--color-border);
    }

    :global([data-theme="dark"] .search-header) {
        border-color: #333;
    }

    .search-header input {
        flex: 1;
        font-size: 1.2rem;
        border: none;
        background: transparent;
        color: var(--color-text);
        outline: none;
    }

    #close-search {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--color-text-muted);
    }

    .search-results {
        padding: 1rem;
        overflow-y: auto;
        flex: 1;
    }

    .search-placeholder {
        text-align: center;
        color: var(--color-text-muted);
        padding: 2rem;
    }

    /* Result Styles */
    :global(.search-group) {
        margin-bottom: 1.5rem;
    }

    :global(.search-group-title) {
        font-size: 0.9rem;
        text-transform: uppercase;
        color: var(--color-text-muted);
        margin-bottom: 0.5rem;
        border-bottom: 1px solid var(--color-border);
        padding-bottom: 0.25rem;
    }

    :global([data-theme="dark"] .search-group-title) {
        border-color: #333;
    }

    :global(.search-result-item) {
        display: block;
        padding: 0.75rem;
        border-radius: 4px;
        text-decoration: none;
        color: var(--color-text);
        transition: background 0.2s;
    }

    :global([data-theme="dark"] .search-result-item) {
        color: #e0e0e0;
    }

    :global([data-theme="light"] .search-result-item) {
        color: #333;
    }

    :global(.search-result-item:hover) {
        background: var(--color-bg-secondary);
    }

    /* Dark Mode Hover Override */
    :global([data-theme="dark"] .search-result-item:hover) {
        background: #333;
    }

    :global(.search-result-title) {
        font-weight: bold;
        display: block;
        margin-bottom: 0.25rem;
    }

    :global(.search-result-excerpt) {
        font-size: 0.9rem;
        color: var(--color-text-muted);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    :global(mark) {
        background: rgba(255, 255, 0, 0.3);
        color: inherit;
    }
</style>

<script is:inline>
    window.loadPagefind = async () => {
        try {
            return await import("/pagefind/pagefind.js");
        } catch (e) {
            console.warn("Failed to load pagefind:", e);
            return null;
        }
    };
</script>

<script>
    import { getPlatform, debounce } from "../../lib/utils";

    let modal: HTMLElement | null;
    let input: HTMLInputElement | null;
    let closeBtn: HTMLElement | null;
    let overlay: HTMLElement | null;
    let resultsContainer: HTMLElement | null;

    // 配置搜索分类
    // key: 对应 data-pagefind-filter="type:..." 的值
    // label: 显示的标题
    const SEARCH_CATEGORIES = [
        { key: "blog", label: "博客文章" },
        { key: "note", label: "笔记" }
        // 在这里添加新的分类...
    ];

    let pagefind: any = null;

    // Open/Close Logic
    function openSearch() {
        if (modal) modal.style.display = "flex";
        input?.focus();
        loadPagefind();
    }

    function closeSearch() {
        if (modal) modal.style.display = "none";
    }

    function handleKeydown(e: KeyboardEvent) {
        if ((e.metaKey || e.ctrlKey) && e.key === "k") {
            e.preventDefault();
            openSearch();
        }
        if (e.key === "Escape") closeSearch();
    }

    // Pagefind Logic
    async function loadPagefind() {
        if (pagefind) return;
        try {
            // 使用全局 loader 绕过 Vite 的静态分析
            if ((window as any).loadPagefind) {
                pagefind = await (window as any).loadPagefind();
                await pagefind.init();
            }
        } catch (e) {
            console.warn(
                "Pagefind not found. It only works in production build."
            );
            if (resultsContainer) {
                resultsContainer.innerHTML =
                    '<div class="search-placeholder">搜索功能仅在构建后可用 (npm run build)</div>';
            }
        }
    }

    async function performSearch(query: string) {
        if (!pagefind || !query.trim()) {
            if (resultsContainer) resultsContainer.innerHTML = "";
            return;
        }

        const search = await pagefind.search(query);
        const results = await Promise.all(
            search.results.map((r: any) => r.data())
        );

        // Group by type based on configuration
        const grouped: Record<string, any[]> = {};

        // Initialize groups
        SEARCH_CATEGORIES.forEach(cat => {
            grouped[cat.key] = [];
        });
        grouped["other"] = []; // Default group for unmatched items

        results.forEach(item => {
            const type = item.filters?.type?.[0];
            if (type && grouped[type]) {
                grouped[type].push(item);
            } else {
                grouped["other"].push(item);
            }
        });

        renderResults(grouped);
    }

    function renderResults(grouped: Record<string, any[]>) {
        if (!resultsContainer) return;

        let html = "";

        // Helper to render a group
        const renderGroup = (title: string, items: any[]) => {
            if (!items || items.length === 0) return "";
            return `
        <div class="search-group">
          <div class="search-group-title">${title}</div>
          ${items
              .map(
                  item => `
            <a href="${item.url}" class="search-result-item">
              <span class="search-result-title">${item.meta.title}</span>
              <span class="search-result-excerpt">${item.excerpt}</span>
            </a>
          `
              )
              .join("")}
        </div>
      `;
        };

        // Render configured categories in order
        SEARCH_CATEGORIES.forEach(cat => {
            html += renderGroup(cat.label, grouped[cat.key]);
        });

        // Render others
        html += renderGroup("其他", grouped["other"]);

        if (html === "") {
            html = '<div class="search-placeholder">未找到相关内容</div>';
        }

        resultsContainer.innerHTML = html;
    }

    // Debounce input
    const debouncedSearch = debounce((val: string) => performSearch(val), 300);

    function init() {
        modal = document.getElementById("search-modal");
        input = document.getElementById(
            "search-input-global"
        ) as HTMLInputElement;
        closeBtn = document.getElementById("close-search");
        overlay = document.querySelector(".search-overlay");
        resultsContainer = document.getElementById("search-results-global");

        // Detect OS for shortcut hint
        const shortcut = getPlatform() === "mac" ? "Cmd+K" : "Ctrl+K";
        if (input) {
            input.placeholder = `搜索全站内容 (${shortcut})...`;
        }

        closeBtn?.addEventListener("click", closeSearch);
        overlay?.addEventListener("click", closeSearch);

        input?.addEventListener("input", e => {
            const val = (e.target as HTMLInputElement).value;
            debouncedSearch(val);
        });

        // Expose open function globally so other buttons can call it
        (window as any).openSearchModal = openSearch;

        // Clean up and re-add window listener
        window.removeEventListener("keydown", handleKeydown);
        window.addEventListener("keydown", handleKeydown);
    }

    document.addEventListener("astro:page-load", init);
</script>
